<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan History - KT Apps</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="../config.js"></script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #030305; color: #fff; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .glass-card { background: #151a25; border: 1px solid rgba(255, 255, 255, 0.05); }
        .glass-card:hover { border-color: rgba(99, 102, 241, 0.3); transform: translateY(-4px); }
    </style>
</head>
<body class="min-h-screen flex flex-col relative overflow-x-hidden">
    <!-- Background -->
    <div class="fixed inset-0 z-[-1] overflow-hidden pointer-events-none">
        <div class="absolute top-[-10%] right-[-10%] w-[40%] h-[40%] rounded-full bg-indigo-900/10 blur-[100px]"></div>
    </div>

    <!-- Header -->
    <header class="sticky top-0 z-40 px-4 py-4">
        <div class="glass rounded-2xl px-4 py-3 flex flex-col md:flex-row justify-between items-center gap-4 max-w-7xl mx-auto">
            <div class="flex items-center gap-4 w-full md:w-auto">
                <a href="scan.html" class="w-10 h-10 rounded-xl glass flex items-center justify-center text-gray-400 hover:text-white transition-colors">
                    <i class="fa-solid fa-arrow-left"></i>
                </a>
                <h1 class="text-lg font-bold">Scan History</h1>
            </div>
            
            <div class="relative w-full md:w-96">
                <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"></i>
                <input type="text" id="search-input" placeholder="Search documents..." class="w-full bg-white/5 border border-white/10 rounded-xl py-2.5 pl-11 pr-4 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-indigo-500/50 focus:bg-white/10 transition-all">
            </div>
        </div>
    </header>

    <!-- Content -->
    <main class="flex-grow p-4 max-w-7xl mx-auto w-full">
        <div id="loader" class="flex flex-col items-center justify-center py-20">
            <div class="w-10 h-10 border-4 border-indigo-500/30 border-t-indigo-500 rounded-full animate-spin mb-4"></div>
            <p class="text-gray-400 text-sm">Loading your documents...</p>
        </div>

        <div id="scan-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 hidden">
            <!-- Scans will be populated here -->
        </div>

        <div id="no-results" class="hidden text-center py-20">
            <div class="w-16 h-16 rounded-full bg-white/5 flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-magnifying-glass text-gray-500 text-xl"></i>
            </div>
            <p class="text-gray-400">No documents found.</p>
        </div>
    </main>

    <!-- Lightbox Modal -->
    <div id="lightbox" class="fixed inset-0 z-50 hidden bg-black/95 backdrop-blur-xl flex items-center justify-center opacity-0 transition-opacity duration-300">
        <button id="close-lightbox" class="absolute top-4 right-4 w-12 h-12 rounded-full bg-white/10 hover:bg-white/20 text-white flex items-center justify-center transition-colors z-50">
            <i class="fa-solid fa-xmark text-xl"></i>
        </button>
        <img id="lightbox-img" src="" class="max-w-[95%] max-h-[90vh] object-contain rounded-lg shadow-2xl transform scale-95 transition-transform duration-300" alt="Full view">
        <div class="absolute bottom-6 left-1/2 -translate-x-1/2 flex gap-4">
            <a id="download-link" href="#" target="_blank" class="px-6 py-2.5 rounded-full bg-white text-black font-bold hover:bg-gray-200 transition-colors flex items-center gap-2 shadow-lg">
                <i class="fa-solid fa-download"></i> Download
            </a>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const scanGrid = document.getElementById('scan-grid');
            const loader = document.getElementById('loader');
            const searchInput = document.getElementById('search-input');
            const noResults = document.getElementById('no-results');
            const lightbox = document.getElementById('lightbox');
            const lightboxImg = document.getElementById('lightbox-img');
            const closeLightbox = document.getElementById('close-lightbox');
            const downloadLink = document.getElementById('download-link');

            let allScans = [];

            async function fetchScans() {
                try {
                    const response = await fetch(CONFIG.GOOGLE_SHEET_URL_SCAN);
                    const result = await response.json();

                    if (result.status === 'success') {
                        allScans = result.data;
                        renderScans(allScans);
                    } else {
                        scanGrid.innerHTML = `<div class="col-span-full text-center text-red-400">Error: ${result.message}</div>`;
                    }
                } catch (error) {
                    scanGrid.innerHTML = `<div class="col-span-full text-center text-red-400">Failed to load data.</div>`;
                } finally {
                    loader.classList.add('hidden');
                    scanGrid.classList.remove('hidden');
                }
            }

            function renderScans(scans) {
                scanGrid.innerHTML = '';
                if (scans.length === 0) {
                    scanGrid.classList.add('hidden');
                    noResults.classList.remove('hidden');
                    return;
                }
                
                scanGrid.classList.remove('hidden');
                noResults.classList.add('hidden');

                scans.forEach(scan => {
                    const date = new Date(scan.timestamp).toLocaleDateString('en-US', {
                        month: 'short', day: 'numeric', year: 'numeric'
                    });
                    
                    // Google Drive Image URL handling
                    let imageUrl = scan.url;
                    if (scan.id) {
                        imageUrl = `https://lh3.googleusercontent.com/d/${scan.id}`;
                    }

                    const card = document.createElement('div');
                    card.className = 'glass-card rounded-2xl overflow-hidden group transition-all duration-300 cursor-pointer';
                    card.innerHTML = `
                        <div class="relative aspect-[4/3] overflow-hidden bg-black/40">
                            <img src="${imageUrl}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" alt="${scan.name}" loading="lazy" onerror="this.src='https://placehold.co/400x300/1e1e1e/FFF?text=No+Preview'">
                            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors"></div>
                            <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <span class="w-8 h-8 rounded-lg bg-black/60 backdrop-blur-md flex items-center justify-center text-white">
                                    <i class="fa-solid fa-expand text-xs"></i>
                                </span>
                            </div>
                        </div>
                        <div class="p-3">
                            <p class="text-xs text-indigo-400 font-semibold mb-1">${date}</p>
                            <h3 class="text-sm font-medium text-gray-200 truncate" title="${scan.name}">${scan.name}</h3>
                        </div>
                    `;

                    card.addEventListener('click', () => openLightbox(imageUrl, scan.url));
                    scanGrid.appendChild(card);
                });
            }

            function openLightbox(imgUrl, driveUrl) {
                lightboxImg.src = imgUrl;
                downloadLink.href = driveUrl;
                lightbox.classList.remove('hidden');
                // Small delay for transition
                setTimeout(() => {
                    lightbox.classList.remove('opacity-0');
                    lightboxImg.classList.remove('scale-95');
                    lightboxImg.classList.add('scale-100');
                }, 10);
            }

            function closeLightboxModal() {
                lightbox.classList.add('opacity-0');
                lightboxImg.classList.remove('scale-100');
                lightboxImg.classList.add('scale-95');
                setTimeout(() => {
                    lightbox.classList.add('hidden');
                    lightboxImg.src = '';
                }, 300);
            }

            closeLightbox.addEventListener('click', closeLightboxModal);
            lightbox.addEventListener('click', (e) => {
                if (e.target === lightbox) closeLightboxModal();
            });

            // Search functionality
            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = allScans.filter(scan => 
                    scan.name.toLowerCase().includes(term) || 
                    (scan.timestamp && scan.timestamp.toLowerCase().includes(term))
                );
                renderScans(filtered);
            });

            fetchScans();
        });
    </script>
</body>
</html>