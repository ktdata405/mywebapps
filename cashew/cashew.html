<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title data-translate-key="cashewExpenseTracker">Cashew - Expense Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="../config.js"></script>
    <style>
        :root {
            --bg-dark: #0b0f19;
            --card-bg: #151a25;
            --primary: #6366f1;
            --accent: #ec4899;
        }

        body {
            background-color: var(--bg-dark);
            color: #f8fafc;
            font-family: 'Plus Jakarta Sans', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* Smooth scrolling */
        html { scroll-behavior: smooth; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        .glass-panel {
            background: rgba(21, 26, 37, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .input-group {
            transition: all 0.3s ease;
        }

        .input-group:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            background: rgba(99, 102, 241, 0.05);
        }

        /* Floating Action Button Animation */
        .fab-hover { transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .fab-hover:active { transform: scale(0.9); }

        /* Date Picker Customization */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            opacity: 0.6;
            cursor: pointer;
        }

        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>

<body class="min-h-screen pb-40 relative overflow-x-hidden">

    <!-- Background Gradients -->
    <div class="fixed inset-0 z-[-1] overflow-hidden pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-[500px] h-[500px] bg-indigo-600/20 rounded-full blur-[100px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[500px] h-[500px] bg-pink-600/20 rounded-full blur-[100px]"></div>
    </div>

    <!-- Header -->
    <header class="sticky top-0 z-30 glass-panel border-b border-white/5 px-6 py-4 mb-8 backdrop-blur-xl bg-[#0b0f19]/80">
        <div class="max-w-3xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="w-11 h-11 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg shadow-indigo-500/20 ring-4 ring-white/5">
                    <i class="fa-solid fa-wallet text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-white leading-tight" data-translate-key="cashew">Cashew</h1>
                    <p class="text-xs text-gray-400 font-medium" data-translate-key="cashewExpenseTrackerShort">Expense Tracker</p>
                </div>
            </div>
            <div class="flex gap-3">
                <a href="cashewreport.html" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 border border-white/5 flex items-center justify-center transition-all text-gray-400 hover:text-white hover:scale-105 active:scale-95">
                    <i class="fa-solid fa-chart-pie"></i>
                </a>
                <a href="../index.html" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 border border-white/5 flex items-center justify-center transition-all text-gray-400 hover:text-white hover:scale-105 active:scale-95">
                    <i class="fa-solid fa-house"></i>
                </a>
            </div>
        </div>
    </header>

    <main class="max-w-3xl mx-auto px-4">

        <!-- Date Navigator -->
        <div class="glass-panel rounded-3xl p-1.5 flex items-center justify-between mb-8 shadow-2xl shadow-black/20 border border-white/10">
            <button id="prev-day" class="w-12 h-12 rounded-2xl hover:bg-white/10 flex items-center justify-center text-gray-400 hover:text-white transition-all active:scale-90">
                <i class="fa-solid fa-chevron-left"></i>
            </button>

            <div class="flex flex-col items-center cursor-pointer group" onclick="document.getElementById('date-input').showPicker()">
                <div class="relative px-4 py-1 rounded-xl group-hover:bg-white/5 transition-colors">
                    <input type="date" id="date-input" class="bg-transparent text-white font-bold text-lg outline-none text-center cursor-pointer font-mono tracking-wide z-10 relative" />
                </div>
                <span class="text-[10px] uppercase tracking-widest text-gray-500 font-bold mt-0.5">
                    <span data-translate-key="lastSeenDate">Last seen date:</span> <span id="last-seen-date" class="text-indigo-400"></span>
                </span>
            </div>

            <button id="next-day" class="w-12 h-12 rounded-2xl hover:bg-white/10 flex items-center justify-center text-gray-400 hover:text-white transition-all active:scale-90">
                <i class="fa-solid fa-chevron-right"></i>
            </button>
        </div>

        <!-- Expenses List -->
        <div id="expenses-container" class="space-y-5">
            <!-- Rows injected via JS -->
        </div>

        <!-- Add Button -->
        <button onclick="addRow()" class="w-full py-4 mt-8 rounded-3xl border border-dashed border-white/20 bg-white/5 hover:bg-indigo-500/10 hover:border-indigo-500/50 text-gray-400 hover:text-indigo-400 transition-all duration-300 flex items-center justify-center gap-3 group active:scale-[0.99]">
            <div class="w-10 h-10 rounded-full bg-white/5 group-hover:bg-indigo-500 group-hover:text-white flex items-center justify-center transition-all shadow-lg">
                <i class="fa-solid fa-plus text-sm"></i>
            </div>
            <span class="font-semibold tracking-wide" data-translate-key="addAnotherExpense">Add Another Expense</span>
        </button>

    </main>

    <!-- Bottom Action Bar -->
    <div class="fixed bottom-0 left-0 w-full glass-panel border-t border-white/10 z-40 pb-safe bg-[#0b0f19]/90 backdrop-blur-xl">
        <div class="max-w-3xl mx-auto px-6 py-4 flex items-center justify-between gap-6">
            <div class="flex flex-col">
                <span class="text-[10px] text-gray-500 font-bold uppercase tracking-wider mb-0.5" data-translate-key="totalExpense">Total Expense</span>
                <span id="total-amount" class="text-2xl font-bold text-white tracking-tight font-mono">Rs. 0.00</span>
            </div>

            <div class="flex items-center gap-3">
                <button onclick="clearAll()" class="w-12 h-12 rounded-2xl bg-white/5 hover:bg-red-500/10 border border-white/5 text-gray-400 hover:text-red-400 flex items-center justify-center transition-all active:scale-95" title="Clear All">
                    <i class="fa-solid fa-trash-can"></i>
                </button>
                <button onclick="saveData()" id="save-btn" class="h-12 px-8 rounded-2xl bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-bold shadow-lg shadow-indigo-600/25 flex items-center gap-2.5 transition-all active:scale-95 hover:shadow-indigo-600/40">
                    <i class="fa-solid fa-check"></i>
                    <span data-translate-key="save">Save</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Loader -->
    <div id="loader" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm transition-all">
        <div class="glass-panel p-8 rounded-3xl flex flex-col items-center gap-6 shadow-2xl">
            <div class="relative w-16 h-16">
                <div class="absolute inset-0 border-4 border-indigo-500/20 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-indigo-500 rounded-full border-t-transparent animate-spin"></div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <i class="fa-solid fa-cloud-arrow-up text-indigo-500"></i>
                </div>
            </div>
            <div class="text-center">
                <h3 class="text-white font-bold text-lg" data-translate-key="savingData">Saving Data</h3>
                <p class="text-gray-400 text-sm mt-1" data-translate-key="syncingWithGoogleSheets">Syncing with Google Sheets...</p>
            </div>
        </div>
    </div>

    <!-- Template -->
    <template id="expense-row-template">
        <div class="expense-row glass-panel p-5 rounded-3xl relative group transition-all duration-300 hover:bg-white/5 border border-white/5 hover:border-indigo-500/30 shadow-lg shadow-black/20">
            <!-- Delete Button -->
            <button onclick="removeRow(this)" class="absolute -top-3 -right-3 w-8 h-8 bg-red-500 text-white rounded-full shadow-lg opacity-0 group-hover:opacity-100 transition-all flex items-center justify-center hover:bg-red-600 z-10 scale-75 group-hover:scale-100 cursor-pointer">
                <i class="fa-solid fa-xmark text-sm"></i>
            </button>

            <div class="flex flex-col gap-4">
                <!-- Header: Category & Amount -->
                <div class="flex items-start gap-4">
                    <!-- Category Icon & Select -->
                    <div class="flex-grow space-y-1.5">
                        <label class="text-[10px] uppercase tracking-wider text-gray-500 font-bold ml-1" data-translate-key="category">Category</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none text-indigo-400">
                                <i class="fa-solid fa-layer-group text-sm"></i>
                            </div>
                            <select class="category-select w-full bg-black/40 border border-white/10 rounded-2xl pl-10 pr-8 py-3.5 text-sm font-semibold text-white outline-none focus:border-indigo-500 focus:bg-black/60 focus:ring-1 focus:ring-indigo-500 transition-all appearance-none cursor-pointer">
                                <option value="Select" class="text-gray-500" data-translate-key="selectCategory">Select Category</option>
                                <option value="Home" data-translate-key="home">Home</option>
                                <option value="My Personal" data-translate-key="myPersonal">My Personal</option>
                                <option value="My Family" data-translate-key="myFamily">My Family</option>
                                <option value="For Latha" data-translate-key="forLatha">For Latha</option>
                                <option value="Baby" data-translate-key="baby">Baby</option>
                                <option value="Credit Card" data-translate-key="creditCard">Credit Card</option>
                                <option value="Mutual Funds/Investments" data-translate-key="mutualFundsInvestments">Mutual Funds/Investments</option>
                                <option value="Lap EMI" data-translate-key="lapEmi">Lap EMI</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 pr-3.5 flex items-center pointer-events-none text-gray-600">
                                <i class="fa-solid fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Amount Input -->
                    <div class="w-[140px] space-y-1.5">
                        <label class="text-[10px] uppercase tracking-wider text-gray-500 font-bold ml-1 text-right block" data-translate-key="amount">Amount</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none text-emerald-400">
                                <i class="fa-solid fa-indian-rupee-sign text-sm"></i>
                            </div>
                            <input type="number" step="0.01" placeholder="0"
                                class="amount-input w-full bg-black/40 border border-white/10 rounded-2xl pl-9 pr-3.5 py-3.5 text-right font-mono text-lg font-bold text-emerald-400 placeholder-gray-700 outline-none focus:border-emerald-500 focus:bg-black/60 focus:ring-1 focus:ring-emerald-500 transition-all"
                                oninput="calculateTotal()">
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <div class="space-y-1.5">
                    <label class="text-[10px] uppercase tracking-wider text-gray-500 font-bold ml-1" data-translate-key="description">Description</label>
                    <div class="relative">
                        <div class="absolute top-3.5 left-3.5 pointer-events-none text-gray-500">
                            <i class="fa-solid fa-align-left text-sm"></i>
                        </div>
                        <textarea
                            class="description-input w-full bg-black/40 border border-white/10 rounded-2xl pl-10 pr-3.5 py-3 text-sm text-gray-300 placeholder-gray-700 outline-none focus:border-indigo-500 focus:bg-black/60 focus:ring-1 focus:ring-indigo-500 transition-all resize-none h-[72px] leading-relaxed"
                            placeholder="What is this for? (e.g. Groceries 500, Milk 30)"
                            data-translate-key="descriptionPlaceholder"
                            oninput="parseAndCalculate(this)"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script src="../localization.js"></script>
    <script>
        let isEditMode = false;
        let originalDate = null;

        /**
         * Reliably parses a date string from formats like 'YYYY-MM-DD' or 'dd/MMM/yyyy'.
         * @param {string} dateString The date string to parse.
         * @returns {Date|null} A Date object or null if parsing fails.
         */
        function parseDate(dateString) {
            if (!dateString) return null;

            // Try parsing YYYY-MM-DD
            let match = dateString.match(/^(\d{4})-(\d{2})-(\d{2})$/);
            if (match) {
                // new Date(year, monthIndex, day) is reliable
                return new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
            }

            // Try parsing dd/MMM/yyyy
            match = dateString.match(/^(\d{2})\/([A-Za-z]{3})\/(\d{4})$/);
            if (match) {
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const monthIndex = months.findIndex(m => m.toLowerCase() === match[2].toLowerCase());
                if (monthIndex !== -1) {
                    return new Date(parseInt(match[3]), monthIndex, parseInt(match[1]));
                }
            }

            // Fallback for other potential ISO-like formats that are safe
            const d = new Date(dateString);
            return !isNaN(d.getTime()) ? d : null;
        }

        function fetchLastEnteredDate() {
            const dateInput = document.getElementById('date-input');
            // Safely get year and month from YYYY-MM-DD string
            const dateParts = dateInput.value.split('-');
            const year = parseInt(dateParts[0]);
            const monthIndex = parseInt(dateParts[1]) - 1;

            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const sheetName = `${months[monthIndex]} ${year}`;

            const label = document.getElementById('last-seen-date');
            if(label) label.textContent = '...';

            fetch(`${CONFIG.GOOGLE_SHEET_URL_CASHEW}?sheetName=${encodeURIComponent(sheetName)}&t=${new Date().getTime()}`)
                .then(response => response.json())
                .then(data => {
                    if (data.data && data.data.length > 0) {
                        let maxDate = null;
                        let maxDateStr = '';

                        data.data.forEach(entry => {
                            if (entry.date) {
                                const d = parseDate(entry.date); // Use robust parser
                                if (d) { // Check if parsing was successful
                                    if (!maxDate || d > maxDate) {
                                        maxDate = d;
                                        maxDateStr = entry.date;
                                    }
                                }
                            }
                        });

                        if (maxDateStr) {
                            label.textContent = formatDateToDDMMMYYYY(maxDateStr);
                        } else {
                            label.textContent = 'None';
                        }
                    } else {
                        if(label) label.textContent = 'None';
                    }
                })
                .catch(error => {
                    console.error('Error fetching last date:', error);
                    if(label) label.textContent = 'Error';
                });
        }

        function getSheetNameFromDate(dateString) {
            const dateObj = parseDate(dateString);
            if (!dateObj) return '';
            const monthIndex = dateObj.getMonth();
            const year = dateObj.getFullYear();
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${months[monthIndex]} ${year}`;
        }

        function fetchDataForDate(dateString) {
            const formattedDate = formatDateToDDMMMYYYY(dateString);
            const sheetName = getSheetNameFromDate(dateString);

            if (!sheetName) return;

            const container = document.getElementById('expenses-container');
            container.innerHTML = '<div class="text-center text-gray-400 py-8">Loading...</div>';

            fetch(`${CONFIG.GOOGLE_SHEET_URL_CASHEW}?sheetName=${encodeURIComponent(sheetName)}&t=${new Date().getTime()}`)
                .then(response => response.json())
                .then(data => {
                    container.innerHTML = '';

                    const expensesForDate = (data.data || []).filter(entry => formatDateToDDMMMYYYY(entry.date) === formattedDate);

                    if (expensesForDate.length > 0) {
                        isEditMode = true;
                        originalDate = formattedDate;
                        expensesForDate.forEach(item => {
                            addRow(item.category, item.description, item.amount);
                        });
                    } else {
                        isEditMode = false;
                        originalDate = null;
                        const defaultCategories = ["Home", "My Personal", "My Family"];
                        for (let i = 0; i < 3; i++) {
                            addRow(defaultCategories[i]);
                        }
                    }
                    calculateTotal();
                })
                .catch(error => {
                    console.error('Error fetching data for date:', error);
                    container.innerHTML = '<div class="text-center text-red-400 py-8">Error loading data. Please try again.</div>';
                    isEditMode = false;
                    originalDate = null;
                    calculateTotal();
                });
        }

        function init() {
            const dateInput = document.getElementById('date-input');

            document.getElementById('prev-day').addEventListener('click', () => changeDate(-1));
            document.getElementById('next-day').addEventListener('click', () => changeDate(1));

            dateInput.addEventListener('change', () => {
                fetchLastEnteredDate();
                fetchDataForDate(dateInput.value);
            });

            const editData = localStorage.getItem('cashewEditData');
            if (editData) {
                isEditMode = true;
                const data = JSON.parse(editData);
                localStorage.removeItem('cashewEditData');

                if (data.length > 0) {
                    const dateObj = parseDate(data[0].date);
                    if (dateObj) {
                        const y = dateObj.getFullYear();
                        const m = String(dateObj.getMonth() + 1).padStart(2, '0');
                        const d = String(dateObj.getDate()).padStart(2, '0');
                        dateInput.value = `${y}-${m}-${d}`;
                    }

                    if (data[0].date) {
                        originalDate = formatDateToDDMMMYYYY(data[0].date);
                    }

                    const container = document.getElementById('expenses-container');
                    container.innerHTML = '';

                    data.forEach(item => {
                        addRow(item.category, item.description, item.amount);
                    });
                    calculateTotal();
                    fetchLastEnteredDate();
                }
            } else {
                const today = new Date().toISOString().split('T')[0];
                dateInput.value = today;
                fetchDataForDate(dateInput.value);
                fetchLastEnteredDate();
            }
        }

        function changeDate(days) {
            const dateInput = document.getElementById('date-input');
            const currentVal = dateInput.value;
            if (!currentVal) return;

            const dateObj = parseDate(currentVal);
            if (!dateObj) return;

            dateObj.setDate(dateObj.getDate() + days);

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (dateObj <= today) {
                const y = dateObj.getFullYear();
                const m = String(dateObj.getMonth() + 1).padStart(2, '0');
                const d = String(dateObj.getDate()).padStart(2, '0');
                const newDate = `${y}-${m}-${d}`;
                dateInput.value = newDate;

                fetchDataForDate(newDate);
                fetchLastEnteredDate();
            }
        }

        function addRow(category, description = '', amount = '') {
            const container = document.getElementById('expenses-container');
            const template = document.getElementById('expense-row-template');
            const clone = template.content.cloneNode(true);

            if (category) {
                const select = clone.querySelector('.category-select');
                let optionExists = false;
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value === category) {
                        optionExists = true;
                        break;
                    }
                }
                if (!optionExists) {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    select.appendChild(option);
                }
                select.value = category;
            }
            if (description) {
                clone.querySelector('.description-input').value = description;
            }
            if (amount !== '') {
                clone.querySelector('.amount-input').value = amount;
            }

            container.appendChild(clone);
        }

        function removeRow(btn) {
            const row = btn.closest('.expense-row');
            const container = document.getElementById('expenses-container');
            if (container.children.length > 1) {
                row.style.opacity = '0';
                row.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    row.remove();
                    calculateTotal();
                }, 200);
            } else {
                row.querySelector('.description-input').value = '';
                row.querySelector('.amount-input').value = '';
                row.querySelector('.category-select').selectedIndex = 0;
                calculateTotal();
            }
        }

        function parseAndCalculate(descInput) {
            const row = descInput.closest('.expense-row');
            const amountInput = row.querySelector('.amount-input');
            const text = descInput.value;

            if (!text) return;

            const parts = text.split(',');
            let total = 0;
            let foundNumber = false;

            parts.forEach(part => {
                const matches = part.match(/(\d+(\.\d+)?|\.\d+)/g);
                if (matches && matches.length > 0) {
                    const lastNumStr = matches[matches.length - 1];
                    const val = parseFloat(lastNumStr);
                    if (!isNaN(val)) {
                        total += val;
                        foundNumber = true;
                    }
                }
            });

            if (foundNumber) {
                amountInput.value = total;
                calculateTotal();
            }
        }

        function calculateTotal() {
            let grandTotal = 0;
            const amounts = document.querySelectorAll('.amount-input');

            amounts.forEach(input => {
                const val = parseFloat(input.value);
                if (!isNaN(val)) {
                    grandTotal += val;
                }
            });

            document.getElementById('total-amount').textContent = `Rs. ${grandTotal.toFixed(2)}`;
        }

        function clearAll() {
            const container = document.getElementById('expenses-container');
            container.innerHTML = '';
            const defaultCategories = ["Home", "My Personal", "My Family"];
            for (let i = 0; i < 3; i++) {
                addRow(defaultCategories[i]);
            }
            calculateTotal();
            isEditMode = false;
            originalDate = null;
        }

        function formatDateToDDMMMYYYY(isoDate) {
            if (!isoDate) return '';
            if (typeof isoDate === 'string' && isoDate.match(/^\d{2}\/[A-Za-z]{3}\/\d{4}$/)) {
                return isoDate;
            }

            const d = parseDate(isoDate);
            if (!d) return isoDate; // Return original if parsing fails

            const day = String(d.getDate()).padStart(2, '0');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${day}/${months[d.getMonth()]}/${d.getFullYear()}`;
        }

        function saveData() {
            const loader = document.getElementById('loader');
            const saveBtn = document.getElementById('save-btn');
            loader.classList.remove('hidden');
            saveBtn.disabled = true;

            const dateInput = document.getElementById('date-input');
            const rows = document.querySelectorAll('.expense-row');
            const expenses = [];
            let grandTotal = 0;

            rows.forEach(row => {
                const category = row.querySelector('.category-select').value;
                const description = row.querySelector('.description-input').value;
                const amount = parseFloat(row.querySelector('.amount-input').value);

                if (category !== 'Select' && !isNaN(amount) && amount > 0) {
                    expenses.push({
                        date: formatDateToDDMMMYYYY(dateInput.value),
                        category: category,
                        description: description,
                        amount: amount
                    });
                    grandTotal += amount;
                }
            });

            if (expenses.length === 0) {
                alert("Please add at least one valid expense.");
                loader.classList.add('hidden');
                saveBtn.disabled = false;
                return;
            }

            if (isEditMode && !originalDate) {
                alert("Error: Original date missing for update. Please go back to report and try again.");
                loader.classList.add('hidden');
                saveBtn.disabled = false;
                return;
            }

            const data = {
                type: 'cashew',
                expenses: expenses,
                total: grandTotal,
                isEdit: isEditMode,
                action: isEditMode ? 'update' : 'add',
                originalDate: originalDate
            };

            fetch(CONFIG.GOOGLE_SHEET_URL_CASHEW, {
                method: 'POST',
                body: JSON.stringify(data),
                mode: 'no-cors'
            })
            .then(response => {
                loader.classList.add('hidden');
                saveBtn.disabled = false;
                alert('✓ Expenses saved successfully!');
                fetchLastEnteredDate();
                if (isEditMode) {
                     window.location.href = 'cashewreport.html';
                } else {
                    clearAll();
                }
            })
            .catch(error => {
                console.error('Network error:', error);
                loader.classList.add('hidden');
                saveBtn.disabled = false;
                alert('⚠ Error sending data: ' + error.message);
            });
        }

        init();
    </script>
</body>

</html>